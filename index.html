<!DOCTYPE html>
<html>
	<head>
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" href="https://code.getmdl.io/1.2.1/material.grey-blue.min.css">
	<script defer src="https://code.getmdl.io/1.2.1/material.min.js"></script>
	<style>
		#info {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			text-align: center;
			width: 50%;
		}
		div:not(#info) {
			width: 200px;
		}
		webview {
			width: 100%;
			height: 100%;
			position: absolute;
			top: 0;
			left: 0;
		}
		body, html {
			overflow: hidden;
		}
	</style>
	</head>
	<body>
		<div id="info">
			<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="field1">
				<input class="mdl-textfield__input" type="text" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}" id="ipAddr">
				<label class="mdl-textfield__label" for="ipAddr">IP Address</label>
				<span class="mdl-textfield__error">Input is not a valid IP Address!</span>
			</div>
			<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="field2">
				<input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?" id="portNum">
				<label class="mdl-textfield__label" for="portNum">Port Number</label>
				<span class="mdl-textfield__error">Input is not a number!</span>
			</div>
			<br />
			<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent" id="connect">
				Connect
			</button>
		</div>
		<script>
			const {ipcRenderer} = require('electron')
			const settings = require('electron-settings');

			settings.get('url.ip').then(val => {
				if (!val) return;
				document.getElementById("ipAddr").value = val;
				document.getElementById("field1").className += " is-dirty";
			});

			settings.get('url.port').then(val => {
				if (!val) return;
				document.getElementById("portNum").value = val;
				document.getElementById("field2").className += " is-dirty";
			});

			var button = document.getElementById("connect");

			button.onclick = function() {
				this.disabled=true;
				var ipAddress = document.getElementById("ipAddr").value;
				var portNum = document.getElementById("portNum").value;

				settings.set("url", {
					ip: ipAddress,
					port: portNum
				});

				var url = "http://" + ipAddress + ":" + portNum;
				document.body.innerHTML = '<webview id="webview" src="'+url+'/" disablewebsecurity nodeintegration></webview>';

				const webview = document.getElementById('webview');

    			webview.addEventListener('did-stop-loading', function() {
					webview.executeJavaScript(`
						var oldWindowFocus = window.focus;
						const {ipcRenderer} = require('electron');

						window.focus = function () {
							ipcRenderer.sendToHost('focus');
							oldWindowFocus();
						}
					`);
				});

				webview.addEventListener('ipc-message', (event) => {
					if (event.channel == 'focus') {
						ipcRenderer.send('window-focus', '');
					}
				});
			}

		</script>
	</body>
</html>
