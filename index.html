<!DOCTYPE html>
<html>
	<head>
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" href="https://code.getmdl.io/1.2.1/material.grey-blue.min.css">
	<script defer src="https://code.getmdl.io/1.2.1/material.min.js"></script>
	<style>
		#info {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			text-align: center;
			width: 50%;
		}
		div:not(#info) {
			width: 200px;
		}
		webview {
			width: 100%;
			height: 100%;
			position: absolute;
			top: 0;
			left: 0;
		}
		body, html {
			overflow: hidden;
		}
		#loading {
			position: fixed;
			width: 100px;
			height: 100px;
			left: 50%;
			top: 50%;
			margin-left: -100px;
			margin-top: -50px;
			background: url('loading.gif') no-repeat center center;
			background-size: contain;

		}
	</style>
	</head>
	<body>
		<div id="info">
			<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="field1">
				<input class="mdl-textfield__input" type="text" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}" id="ipAddr">
				<label class="mdl-textfield__label" for="ipAddr">IP Address</label>
				<span class="mdl-textfield__error">Input is not a valid IP Address!</span>
			</div>
			<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="field2">
				<input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?" id="portNum">
				<label class="mdl-textfield__label" for="portNum">Port Number</label>
				<span class="mdl-textfield__error">Input is not a number!</span>
			</div>
			<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="field3">
				<input class="mdl-textfield__input" type="text" id="username">
				<label class="mdl-textfield__label" for="username">Username</label>
			</div>
			<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" id="field4">
				<input class="mdl-textfield__input" type="password" id="password">
				<label class="mdl-textfield__label" for="password">Password</label>
			</div>
			<br />
			<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent" id="connect">
				Connect
			</button>
		</div>
		<script>
			const {ipcRenderer} = require('electron');
			const settings = require('electron-settings');
			const http = require('http');

			settings.get('urlRemoteMessages.ip').then(val => {
				if (!val) return;
				document.getElementById("ipAddr").value = val;
				document.getElementById("field1").className += " is-dirty";
			});

			settings.get('urlRemoteMessages.port').then(val => {
				if (!val) return;
				document.getElementById("portNum").value = val;
				document.getElementById("field2").className += " is-dirty";
			});

			settings.get('urlRemoteMessages.username').then(val => {
				if (!val) return;
				document.getElementById("username").value = val;
				document.getElementById("field3").className += " is-dirty";
			});

			settings.get('urlRemoteMessages.password').then(val => {
				if (!val) return;
				document.getElementById("password").value = val;
				document.getElementById("field4").className += " is-dirty";
			});

			var button = document.getElementById("connect");

			button.onclick = function() {
				this.disabled = true;
				this.innerHTML = 'Connecting...';

				var ipAddress = document.getElementById("ipAddr").value;
				var portNum = document.getElementById("portNum").value;
				var username = document.getElementById("username").value;
				var password = document.getElementById("password").value;

				settings.set("urlRemoteMessages", {
					ip: ipAddress,
					port: portNum,
					username: username,
					password: password
				});

				var url = "http://" + username + ":" + password + "@" + ipAddress + ":" + portNum;

				var req = http.request({method: 'HEAD', host: ipAddress, port: portNum, path: '/'}, function(r) {
					document.body.innerHTML = '<webview id="webview" src="'+url+'/" disablewebsecurity nodeintegration></webview><div id="loading"></div>';
					document.getElementById("loading").style.visibility = "";
					const webview = document.getElementById('webview');

	    			webview.addEventListener('did-stop-loading', function() {
						webview.executeJavaScript(`
							var oldWindowFocus = window.focus;
							const {ipcRenderer} = require('electron');

							window.focus = function () {
								ipcRenderer.sendToHost('focus');
								oldWindowFocus();
							}
						`);
						document.getElementById("loading").remove();
					});

	    			webview.addEventListener('did-start-loading', function() {
					});

					webview.addEventListener('ipc-message', (event) => {
						if (event.channel == 'focus') {
							ipcRenderer.send('window-focus', '');
						}
					});
				});

				req.on('error', function(err) {
					alert('Unable to connect to the Remote Messages server. Make sure you have the correct IP and port.');
					document.getElementById('connect').disabled = false;
					document.getElementById('connect').innerHTML = 'Connect';
				});

				req.on('socket', function (socket) {
					socket.setTimeout(10000);
					socket.on('timeout', function() {
				        req.abort();
				    });
				});

				req.setTimeout(10000);
				req.end();
			}

		</script>
	</body>
</html>
